import"./modulepreload-polyfill-DQ8RlzRK.js";window.onload=()=>{let e=document.getElementById(`webcam`),t=document.getElementById(`tip`),n=document.getElementById(`result`),r=document.getElementById(`canvas`),i=document.getElementById(`canvasContainer`),a=document.getElementById(`scan`),o=document.getElementById(`copy`),s=r.getContext(`2d`,{willReadFrequently:!0}),c=0,l=0,u=null,d=()=>{let e=i.clientWidth*window.devicePixelRatio,t=i.clientHeight*window.devicePixelRatio;r.width=e,r.height=t},f=()=>{let t=r.width,n=r.height,i=e.videoWidth/e.videoHeight,a=t/n,o=0,s=0,c=0,l=0;return i>a?(l=n,c=n*i,o=(t-c)/2):(c=t,l=t/i,s=(n-l)/2),{x:o,y:s,w:c,h:l}},p=()=>{let e=new window.AudioContext,t=e.createOscillator(),n=e.createGain();t.connect(n),n.connect(e.destination),t.frequency.setValueAtTime(1200,e.currentTime),n.gain.setValueAtTime(.1,e.currentTime),t.start(),t.stop(e.currentTime+.2)},m=()=>{if(!u)try{u=new Worker(new URL(`/tricode/assets/detector-uGoaTDZ2.js`,``+import.meta.url),{type:`module`}),u.onmessage=e=>{let t=e.data;t.success&&(n.textContent=t.text,p())},u.onerror=e=>{console.error(e),v()}}catch(e){console.error(e),u=null}};async function h(){if(!e.srcObject)try{e.srcObject=await navigator.mediaDevices?.getUserMedia({video:{facingMode:{ideal:`environment`},width:{ideal:1080},height:{ideal:1920}}}),e.onloadedmetadata=async()=>{await e.play(),d(),g()}}catch(e){console.error(e)}}let g=()=>{if(e.paused)return;s.clearRect(0,0,r.width,r.height);let i=f();s.drawImage(e,0,0,e.videoWidth,e.videoHeight,i.x,i.y,i.w,i.h);let a=Math.min(r.width,r.height)*.9,o=a*(Math.sqrt(3)/2),d=(r.width-a)/2,p=r.height/2+o/3,m=p-o;if(t.style.top=`calc(${m/x}px - 3rem)`,n.style.top=`calc(${p/x}px + 1rem)`,l++,l>=30){l=0;let e=Math.floor(a),t=Math.floor(o),n=s.getImageData(d,m,e,t);u&&u.postMessage({imageData:n.data,width:e,height:t},[n.data.buffer])}c=requestAnimationFrame(g)},_=()=>{if(!c)return;cancelAnimationFrame(c);let t=e.srcObject;t&&(t.getTracks().forEach(e=>e.stop()),e.srcObject=null)},v=()=>{u&&=(u.terminate(),null)};window.addEventListener(`pageshow`,()=>{m(),h().then()}),window.addEventListener(`beforeunload`,()=>{_(),v()});let y=document.getElementById(`maskCanvas`),b=y.getContext(`2d`),x=window.devicePixelRatio||1,S=()=>{let e=window.innerWidth,t=window.innerHeight;y.width=e*x,y.height=t*x,y.style.width=`${e}px`,y.style.height=`${t}px`,b.scale(x,x);let n=Math.min(e,t)*.9,r=n*(Math.sqrt(3)/2),i=(e-n)/2,a=t/2+r/3,o=(e+n)/2,s=a,c=e/2,l=a-r;b.fillStyle=`rgba(0, 0, 0, 0.7)`,b.fillRect(0,0,e,t),b.save(),b.strokeStyle=`#ffffff`,b.lineWidth=1,b.beginPath(),b.moveTo(i,a),b.lineTo(o,s),b.lineTo(c,l),b.closePath(),b.stroke(),b.beginPath(),b.moveTo(i,a),b.lineTo(o,s),b.lineTo(c,l),b.closePath(),b.globalCompositeOperation=`destination-out`,b.fill(),b.restore()};m(),h().then(),S(),a.onclick=()=>{n.textContent=``};async function C(e){try{return await navigator.clipboard.writeText(e),console.log(`Copy successful!`),e}catch(e){throw console.error(`Copy failed: `,e),Error(`複製失敗，請手動複製`)}}o.onclick=async()=>{try{await C(n.textContent),alert(`複製成功`)}catch(e){alert(e.message)}},window.addEventListener(`resize`,()=>{d(),S()})};